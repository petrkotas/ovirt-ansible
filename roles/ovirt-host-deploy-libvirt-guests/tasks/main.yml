---
- name: Fetch info about VDSM
  command: bash -c "rpm -qi vdsm | grep -oE 'Version\\s+:\\s+[0-9\\.]+' | awk '{print $3}'"
  changed_when: false
  register: vdsm_version

- block:
    - name: Change default timeout if setup
      ini_file:
        state: present
        section: null
        path: /etc/sysconfig/libvirt-guests
        option: "SHUTDOWN_TIMEOUT"
        value: "{{ host_deploy_shutdown_timeout }}"
      when:
        - host_deploy_shutdown_timeout is defined

    - name: Change run in parallel if setup
      ini_file:
        state: present
        section: null
        path: /etc/sysconfig/libvirt-guests
        option: "PARALLEL_SHUTDOWN "
        value: "{{ host_deploy_shutdown_parallel }}"
      when:
        - host_deploy_shutdown_parallel is defined

    - name: Start libvirt-guests service
      service:
        name: libvirt-guests
        state: restarted
        enabled: yes

  when:
    - "vdsm_version | version_compare('4.20', '>=')"
